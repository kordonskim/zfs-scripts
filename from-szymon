https://gist.github.com/jimboy-701/18f89b58adf2c0fa25e20015b41f1f76

DISK=/dev/nvme0n1
DISK=/dev/sda

echo -e "\n${GRN}Ceanup...${NC}\n"
sudo umount -Rl /mnt \
sudo swapoff /dev/sdb3 \
sudo zpool export rpool

sgdisk --zap-all $DISK
sgdisk -n1:1M:+1024M -t1:EF00 $DISK
sgdisk -n2:0:0 -t2:BF00 $DISK
mkfs.vfat -v -F 32 -n EFI /dev/nvme0n1p1

zpool create -f -o ashift=12 \
-o autotrim=on \
-O devices=off \
-O canmount=off \
-O mountpoint=none \
-R /mnt/boot \
zboot /dev/sda2 

zpool create -f -o ashift=12 \
-o autotrim=on \
-O devices=off \
-O relatime=on \
-O xattr=sa \
-O acltype=posixacl \
-O normalization=formD \
-O compression=zstd \
-O canmount=off \
-O mountpoint=none \
-R /mnt \
zroot /dev/sda2

zfs create zroot/ROOT
zfs create -o canmount=noauto -o mountpoint=/ zroot/ROOT/arch
zfs create -o mountpoint=/home zroot/home
zpool export zroot

zpool import -d /dev/sda2 -R /mnt zroot -N
zfs mount zroot/ROOT/arch
zfs mount -a
mkdir -p /mnt/{etc/zfs,boot/efi}
mount /dev/nvme0n1p1 /mnt/boot/efi

// mount | grep mnt

zpool set bootfs=zroot/ROOT/arch zroot
zpool set cachefile=/etc/zfs/zpool.cache zroot
cp -v /etc/zfs/zpool.cache /mnt/etc/zfs

pacman -Syy
pacstrap /mnt base base-devel linux linux-headers linux-firmware intel-ucode dkms efibootmgr man-db man-pages git neovim mc ripgrep fish starship sudo reflector openssh htop btop fzf wget terminus-font btrfs-progs
genfstab -U -p /mnt >> /mnt/etc/fstab

vim /mnt/etc/fstab

cp -v /etc/resolv.conf /mnt/etc
arch-chroot /mnt
useradd -m mk
passwd mk
usermod -aG users,sys,adm,log,scanner,power,rfkill,video,storage,optical,lp,audio,wheel mk

nvim /etc/sudoers

su mk
cd
sudo pacman -Syy
git clone https://aur.archlinux.org/yay.git
cd yay
makepkg -si
yay -S zfs-dkms

sudo systemctl enable zfs-import-cache
sudo systemctl enable zfs-import.target
sudo systemctl enable zfs-mount
sudo systemctl enable zfs-share
sudo systemctl enable zfs-zed
sudo systemctl enable zfs.target
sudo systemctl enable reflector.timer

sudo zgenhostid $(hostid)
hostid

//a8c0ec01

sudo ln -sf /usr/share/zoneinfo/America/Chicago /etc/localtime
sudo hwclock --systohc

sudo nvim /etc/locale.gen
sudo locale-gen

// from root: echo "topton" > /etc/hostname

sudo nvim /etc/xdg/reflector/reflector.conf
sudo nvim /etc/vconsole.conf
FONT=ter-128n

mkdir -p /boot/efi/EFI/zbm
wget https://get.zfsbootmenu.org/latest.EFI -O /boot/efi/EFI/zbm/zfsbootmenu.EFI

// efibootmgr -Bb number

efibootmgr --disk /dev/nvme0n1 --part 1 --create --label "ZFSBootMenu" --loader '\EFI\zbm\zfsbootmenu.EFI' --unicode "spl_hostid=$(hostid) zbm.timeout=3 zbm.prefer=zroot zbm.import_policy=hostid" --verbose

zfs set org.zfsbootmenu:commandline="noresume init_on_alloc=0 rw spl.spl_hostid=$(hostid)" zroot/ROOT

nvim /mnt/etc/mkinitcpio.conf
// add zfs!!! HOOKS=(base udev autodetect modconf kms keyboard keymap consolefont block zfs filesystems fsck)
yay -S mkinitcpio-firmware
mkinitcpio -P
passwd root
umount /boot/efi

// exit chroot
zfs umount -a
zpool export zroot
reboot